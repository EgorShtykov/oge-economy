<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ì–≠ –≠–∫–æ–Ω–æ–º–∏–∫–∞</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
        .user-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        .user-bar button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        .user-bar button:hover { background: #ee5a5a; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        #auth-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .auth-box input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
        }
        .auth-box button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .auth-box button:hover { background: #764ba2; }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; padding: 40px 20px; }
        .balance-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .balance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: center;
        }
        .balance-item { padding: 20px; background: #f5f7fa; border-radius: 15px; }
        .balance-amount { font-size: 3rem; font-weight: bold; color: #667eea; }
        
        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .task-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-decoration: none;
            text-align: center;
            display: block;
        }
        .task-number { font-size: 2rem; font-weight: bold; }
        
        .action-btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: #333;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            margin: 10px;
        }
    </style>
</head>
<body>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
    <div class="user-bar" id="user-bar">
        <span id="user-phone">üì±</span>
        <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
    <div id="auth-modal">
        <div class="auth-box">
            <h2 style="color: #667eea; margin-bottom: 20px;">üíé –í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É</h2>
            <input type="tel" id="phone-input" placeholder="+7 (999) 123-45-67">
            <div id="recaptcha-container"></div>
            <button onclick="sendCode()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ SMS</button>
            
            <div id="code-section" style="display: none; margin-top: 20px;">
                <input type="text" id="code-input" placeholder="–ö–æ–¥ –∏–∑ SMS" maxlength="6">
                <button onclick="verifyCode()" style="background: #4CAF50;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <br><br>
                <a href="#" onclick="backToPhone()" style="color: #999; font-size: 14px;">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä</a>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üéÆ –û–ì–≠ –≠–∫–æ–Ω–æ–º–∏–∫–∞</h1>
            <p style="font-size: 1.2rem; opacity: 0.9;">–†–µ—à–∞–π –∑–∞–¥–∞—á–∏ ‚Äî –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –∫—Ä–∏—Å—Ç–∞–ª–ª—ã!</p>
        </header>

        <div class="balance-section">
            <div class="balance-grid">
                <div class="balance-item">
                    <div style="font-size: 3rem;">üíé</div>
                    <div class="balance-amount" id="crystals">0</div>
                    <div>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã</div>
                </div>
                <div class="balance-item">
                    <div style="font-size: 3rem;">‚≠ê</div>
                    <div class="balance-amount" id="xp">0</div>
                    <div>XP</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìö –ó–∞–¥–∞–Ω–∏—è –û–ì–≠</h2>
            <div class="tasks-grid">
                <a href="oge15.html" class="task-card">
                    <div class="task-number">15</div>
                    <div>–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏</div>
                </a>
                <a href="oge16.html" class="task-card">
                    <div class="task-number">16</div>
                    <div>–û–∫—Ä—É–∂–Ω–æ—Å—Ç—å</div>
                </a>
                <a href="oge17.html" class="task-card">
                    <div class="task-number">17</div>
                    <div>–ü–ª–æ—â–∞–¥–∏</div>
                </a>
                <a href="oge18.html" class="task-card">
                    <div class="task-number">18</div>
                    <div>–ù–∞ –∫–ª–µ—Ç—á–∞—Ç–æ–π –±—É–º–∞–≥–µ</div>
                </a>
                <a href="oge19.html" class="task-card">
                    <div class="task-number">19</div>
                    <div>–ì–µ–æ–º–µ—Ç—Ä–∏—è</div>
                </a>
            </div>
        </div>

        <div style="text-align: center;">
            <a href="shop.html" class="action-btn">üõí –ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–∑–æ–≤</a>
            <button class="action-btn" onclick="addTestCrystals()" style="border: none; cursor: pointer;">üí∞ –¢–µ—Å—Ç: +10 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤</button>
        </div>
    </div>

    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyCd8k0YuzolJV1-SU5KghkgsET_rU3yH9s",
            authDomain: "egor-20d85.firebaseapp.com",
            projectId: "egor-20d85",
            storageBucket: "egor-20d85.firebasestorage.app",
            messagingSenderId: "879206703089",
            appId: "1:879206703089:web:2d0b4659b61502c4c56e50"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let confirmationResult = null;
        let recaptchaVerifier = null;
        let currentUser = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initRecaptcha();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('–í–æ—à–µ–ª:', user.phoneNumber);
                    currentUser = user;
                    await loadUserData(user);
                    document.getElementById('auth-modal').style.display = 'none';
                    showUserBar(user.phoneNumber);
                } else {
                    console.log('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    document.getElementById('auth-modal').style.display = 'flex';
                }
            });

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            document.getElementById('phone-input').addEventListener('input', function(e) {
                let val = e.target.value.replace(/\D/g, '');
                if (val[0] === '7' || val[0] === '8') val = val.slice(1);
                let res = '+7';
                if (val.length > 0) res += ' (' + val.slice(0,3);
                if (val.length >= 3) res += ') ' + val.slice(3,6);
                if (val.length >= 6) res += '-' + val.slice(6,8);
                if (val.length >= 8) res += '-' + val.slice(8,10);
                e.target.value = res;
            });
        });

        function initRecaptcha() {
            try {
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible'
                });
                recaptchaVerifier.render();
            } catch(e) {
                console.log('reCAPTCHA —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }
        }

        async function loadUserData(user) {
            try {
                const docRef = db.collection('students').doc(user.uid);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('crystals').textContent = data.crystals || 0;
                    document.getElementById('xp').textContent = data.xp || 0;
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                    await docRef.set({
                        phone: user.phoneNumber || 'unknown',
                        crystals: 0,
                        xp: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('crystals').textContent = '0';
                    document.getElementById('xp').textContent = '0';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            }
        }

        function showUserBar(phone) {
            const bar = document.getElementById('user-bar');
            const phoneSpan = document.getElementById('user-phone');
            if (phone) {
                phoneSpan.textContent = phone;
            } else {
                phoneSpan.textContent = 'üë§ –ì–æ—Å—Ç—å';
            }
            bar.style.display = 'flex';
        }

        async function sendCode() {
            const phone = document.getElementById('phone-input').value.replace(/[()\s-]/g, '');
            
            if (!phone.match(/^\+7\d{10}$/)) {
                alert('–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX');
                return;
            }

            try {
                confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);
                document.getElementById('phone-section').style.display = 'none';
                document.getElementById('code-section').style.display = 'block';
                alert('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –î–ª—è —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π: 123456');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                console.error(error);
            }
        }

        async function verifyCode() {
            const code = document.getElementById('code-input').value;
            if (code.length !== 6) {
                alert('–í–≤–µ–¥–∏ 6 —Ü–∏—Ñ—Ä');
                return;
            }

            try {
                await confirmationResult.confirm(code);
                // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –≤ onAuthStateChanged
            } catch (error) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
            }
        }

        function backToPhone() {
            document.getElementById('code-section').style.display = 'none';
            document.getElementById('phone-section').style.display = 'block';
            document.getElementById('code-input').value = '';
        }

        async function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                await auth.signOut();
                location.reload();
            }
        }

        // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
        async function addTestCrystals() {
            if (!currentUser) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ –≤ —Å–∏—Å—Ç–µ–º—É!');
                return;
            }
            
            try {
                const userRef = db.collection('students').doc(currentUser.uid);
                await userRef.update({
                    crystals: firebase.firestore.FieldValue.increment(10)
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const doc = await userRef.get();
                document.getElementById('crystals').textContent = doc.data().crystals;
                alert('+10 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
    </script>
</body>
</html>
